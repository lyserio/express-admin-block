<html>
	<head>
		<title>Admin Panel</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<link rel='stylesheet' href="https://cdn.datatables.net/1.10.18/css/dataTables.bootstrap4.min.css" media="none" onload="if(media!='all')media='all'">
		<link rel='stylesheet' href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" media="none" onload="if(media!='all')media='all'">
		<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" media="none" onload="if(media!='all')media='all'">

		<script src="https://unpkg.com/form-storage@1.2.0/build/form-storage.js"></script>

		<link rel="icon" type="image/png" href="/icons/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	</head>
	<body>
		<div class='container py-4'>
			<h2 class="display-4">Admin panel</h2>

			<ul class="mt-5 nav nav-tabs">
				<% for (let tab of tabs) { %>
					<li class="nav-item">
						<a class="nav-link active" data-tab="<%= tab.id %>" onclick="show('<%= tab.id %>')" href="javascript:"><%= tab.name %></a>
					</li>
				<% } %>
				<li class="nav-item">
					<a class="nav-link active" data-tab="broadcast" onclick="show('broadcast')" href="javascript:">Broadcast</a>
				</li>
			</ul>
			
			<br>
			
			<% for (let tab of tabs) { %>
				<div class='mt-3 tab' id="<%= tab.id %>" style="display: none">
					<table class='table table-sm'>
						<thead>
							<tr class="text-left">
								<% for (let field of tab.fields) { %>
									<th scope="col"><%= field %></th>
								<% } %>
							</tr>
						</thead>
						<tbody>

						<% for (let item of tab.array) { %>
							<tr>
								<% for (let field of tab.fields) { %>
									<td><%= item[field] %></td>
								<% } %>
							</tr>
						<% } %>

						</tbody>
					</table>


					<canvas class='mt-5' id="<%= tab.id %>Chart" width="400" height="100"></canvas>

				</div>
			<% } %>

			<div class='tab' id="broadcast" style="display: none">
				<h3>Broadcasting system</h3>
				<p>Based on Mailgun x MongoDB</p>

				<form id='broadcastForm' class='mt-5' method="POST" action="/admin/broadcast">
					<div class='row form-group'>
						<div class='col'>
							<input class='form-control' type="text" name="fromName" placeholder="Tom from MySpace">
						</div>
						<div class='col'>
							<input class='form-control' type="text" name="fromEmail" placeholder="email@example.org">
						</div>
						<div class='col'>
							<input class='form-control' type="text" name="domain" placeholder="mg.example.org">
						</div>
						<div class='col'>
							<input class='form-control' type="text" name="mongoQuery" placeholder="{}">
						</div>
					</div>
					<div class='row form-group'>
						<div class='col'>
							<input class='form-control' type="text" name="subject" placeholder="Some News">
						</div>
						<div class="col">
							<select name="tag" class="form-control">
								<option value="product-update" selected>product-update</option>
								<option value="security-update">security-update</option>
								<option value="promotion">promotion</option>
							</select>
						</div>
					</div>

					<div style='height: 300px' name='editor' id="editor">
						<p>Hello everyone!</p>
					</div>

					<div class='mt-3 row form-group'>
						<div class="col">
							<textarea class='form-control' form="broadcastForm" name="messageHTML" rows="5">HTML will be here</textarea>
						</div>
						<div class="col">
							<textarea class='form-control' form="broadcastForm" name="messageText" rows="5">text will be here</textarea>
						</div>
					</div>

					<br>
					
					<p><small>This will automatically include an unsubscribe link and track opens/clicks in Mailgun.</small></p>
					
					<label class="form-checkbox">
						<input type="checkbox" checked class="js-persist" />
						Save data to localstorage
					</label>
					<br>

					<input type="submit" class='btn btn-warning' value="Send to everyone">
				</form>
			</div>
		</div>
	</body>

	<footer>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
		<script src='https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js'></script>
		<script src='https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap4.min.js'></script>
		<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
		
		<script>
			var quill = new Quill('#editor', {
				theme: 'snow'
			})

			// So we don't type the same shit everytime
			new FormStorage('#broadcastForm', {
				name: 'form-broadcast',
				checkbox: '.js-persist'
			})

			$(document).ready( () => {
				$.each($('table'), (index, table) => {
					$(table).DataTable();   
				})
			})

			quill.on('editor-change', () => {
				$("[name='messageHTML']").val($('#editor').children().first().html())
				$("[name='messageText']").val(quill.getText())
			})

			<% for (let tab of tabs) { %>

				var ctx = document.getElementById("<%= tab.id %>Chart")
				var myChart = new Chart(ctx, {
					type: 'line',
					options: {
						elements: {
							point: {
								radius: 0
							}
						}
					},
					data: {
						labels: <%- JSON.stringify(tab.labels) %>,
						datasets: [{
							label: '# of <%= tab.id %>',
							data: <%- JSON.stringify(tab.amounts) %>
						}]
					}
				})
			<% } %>
		</script>
		<script>
			// Switch tabs
			function show(what) {

				$('.tab').hide()

				$('[data-tab].active').removeClass('active')
				$('[data-tab="'+what+'"]').addClass('active')
				$('#'+what).show()

				if ('URLSearchParams' in window) {
					let searchParams = new URLSearchParams(window.location.search)
					searchParams.set("tab", what)
					let newRelativePathQuery = window.location.pathname + '?' + searchParams.toString()
					history.pushState(null, '', newRelativePathQuery)
				}
			}

			let tab = location.search.split('tab=')[1]
			if (tab) show(tab)
			else show("<%= tabs[0].id %>")
		</script>
	</footer>
</html>